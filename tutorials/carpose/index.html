<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><title>Car Pose Detection and Yolo Learning - MuSHR: The UW Open Racecar Project</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=https://mushr.io/favicon.png><link rel=stylesheet href=/css/style.min.d6c2c7df4a2b74e47c295ee499fec19eb99dfe63f90766a829090f557e381bdc.css></head><body class='page page-tutorials-single'><div id=main-menu-mobile class=main-menu-mobile><ul><li class=menu-item-quickstart><a href=/tutorials/noetic_quickstart/><span>Quickstart</span></a></li><li class=menu-item-about><a href=/about/><span>About</span></a></li><li class=menu-item-docs><a href=https://github.com/prl-mushr/mushr#component-documentation><span>Docs</span></a></li><li class=menu-item-hardware><a href=/hardware/><span>Hardware</span></a></li><li class="menu-item-tutorials active"><a href=/tutorials/><span>Tutorials</span></a></li><li class=menu-item-press><a href=/press/><span>Press</span></a></li><li class=menu-item-team><a href=https://personalrobotics.cs.washington.edu/people/><span>Team</span></a></li><li class=menu-item-forum><a href=https://github.com/prl-mushr/mushr/discussions><span>Community Forum</span></a></li><li class=menu-item-contact><a href=/contact/><span>Contact</span></a></li></ul></div><div class=wrapper><div class=header><div class=container><div class=logo><a href=https://mushr.io/><img alt="Figurit Homepage" src=https://mushr.io/imgs/mushr-logo.svg></a></div><div class=logo-mobile><a href=https://mushr.io/><img alt="Figurit Homepage" src=https://mushr.io/imgs/mushr-logo.svg></a></div><div id=main-menu class=main-menu><ul><li class=menu-item-quickstart><a href=/tutorials/noetic_quickstart/><span>Quickstart</span></a></li><li class=menu-item-about><a href=/about/><span>About</span></a></li><li class=menu-item-docs><a href=https://github.com/prl-mushr/mushr#component-documentation><span>Docs</span></a></li><li class=menu-item-hardware><a href=/hardware/><span>Hardware</span></a></li><li class="menu-item-tutorials active"><a href=/tutorials/><span>Tutorials</span></a></li><li class=menu-item-press><a href=/press/><span>Press</span></a></li><li class=menu-item-team><a href=https://personalrobotics.cs.washington.edu/people/><span>Team</span></a></li><li class=menu-item-forum><a href=https://github.com/prl-mushr/mushr/discussions><span>Community Forum</span></a></li><li class=menu-item-contact><a href=/contact/><span>Contact</span></a></li></ul></div><button id=toggle-main-menu-mobile class="hamburger hamburger--slider" role=presentation aria-label="mobile menu trigger">
<span class=hamburger-box><span class=hamburger-inner></span></span></button></div></div><div class="container pb-6 pt-6 pt-md-10 pb-md-10"><div class="row justify-content-start"><div class="col-12 col-md-8"><div class="tutorial tutorial-single"><h1 class=title>Car Pose Detection and Yolo Learning</h1><div class=content><p>Train a model to detect MuSHR cars.</p><h4 class=properties>Intermediate Tutorial | Expected duration is 60 minutes</h4><h2>By: Tudor Fanaru</a> & <a href=https://github.com/seanlovesworld>Sean Chen</a></h2><figure><img src=/tutorials/carpose/carpose.jpg width=800></figure><br><h2 id=introduction>Introduction</h2><h3 id=goal>Goal</h3><p>In a multi-agent system, car detection is one of the fundamental processes that must take place in order for cars to make decisions from their oberservations. This applies to collision avoidance & navigation, as well as any other form of cooperative task. This tutorial will provide instructions for producing bounding prisms to label cars based on mocap car pose data, and training a model from your newly labeled data.</p><h3 id=requirements>Requirements</h3><ul><li>Understanding of Linear Algebra</li><li>Complete the <a href=https://mushr.io/tutorials/quickstart/>quickstart tutorial</a></li><li>Complete the <a href=https://mushr.io/tutorials/intro-to-ros/>Intro to ROS tutorial</a></li><li>Recommended Readings:<ul><li><a href=http://wiki.ros.org/image_geometry/Tutorials/ProjectTfFrameToImage>Projecting a TF frame onto an image (C++)</a></li><li><a href=http://www.cs.toronto.edu/~jepson/csc420/notes/imageProjection.pdf>Image Projection</a></li></ul></li></ul><h3 id=mathematical-explanations>Mathematical Explanations</h3><p>It is important to remember that the sensor measurements from the cars and mocap all have their own frame of reference. In order to combine these into a bounding box within a single car&rsquo;s camera frame, we need to be able to switch between frames of reference in a computationally effective way. This is done through the use of transforms.
There are 4 important frames of reference: the world (where the mocap marker is tracked), the base_link (root of a car&rsquo;s tf tree), the camera on the car, and the centroid of a car (used to generate a bounding prism). Being able to move between these frames of reference is necessary to derive the true position of a car on a camera frame, and create a corresponding label.</p><p>In this example, car 1 is being viewed by car 2&rsquo;s camera.
Let x_T_y mean the transform of x w.r.t. y:</p><ul><li>marker1_T_cam2 = base2_T_cam2 * marker2_T_base2 * world_T_marker2 * marker1_T_world</li><li>center1_T_cam2 = marker1_T_cam2 * base1_T_marker1 * center1_T_base1</li></ul><p>marker1_T_world and marker2_T_world are given by the mocap data
world_T_marker2 is the inverse of marker2_T_world
base_T_cam, marker_T_base, center_T_base are all constants depending on how you set up your system</p><h2 id=bag-creation>Bag Creation:</h2><p>Whether you create your own dataset using your own bag(s), or you use ours, these are the key ROS topics for each car:</p><ul><li>d435 color camera: /carXX/camera/color/image_throttled</li><li>mocap pose: /vrpn_client_node/carXX/pose</li><li>camera parameters: /carXX/camera/color/camera_info</li></ul><p>You can download <a href="https://drive.google.com/file/d/188FisqxHnleVF0pH2rgzhl2GQax44CwF/view?usp=sharing">our bag</a> to see how we gathered data, or to follow along the rest of the tutorial with.</p><h2 id=creating-your-dataset>Creating Your Dataset:</h2><p>Now that you have a bag, you will use gen_darknet_label.py to create your labels & dataset in the darknet format. The implementation of YOLOv5 we are using requires the dataset to be in darknet format:</p><ul><li>bounding boxes are represented by (x_center, y_center, w, h)</li><li>each value is in terms of the dimension of the image between 0 and 1</li></ul><p>Create a dataset directory, and create two subdirectories: images & labels. Run the gen_darknet_label.py script to populate the directories with images and labels. When finished, your dataset directory should look like this:<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>	dataset/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		images/
</span></span><span class=line><span class=cl>			img_000000.jpg
</span></span><span class=line><span class=cl>			img_000001.jpg
</span></span><span class=line><span class=cl>			...
</span></span><span class=line><span class=cl>		labels/
</span></span><span class=line><span class=cl>			img_000000.txt
</span></span><span class=line><span class=cl>			img_000001.jpg
</span></span><span class=line><span class=cl>			...</span></span></code></pre></div></p><p>You can download <a href="https://drive.google.com/file/d/1OlQMDoQdRHgOkPv0MNK6GRmy67pbF8c_/view?usp=sharing">our dataset</a> to jump right into the machine-learning aspect of this tutorial.</p><h3 id=labeling-implementation>Labeling Implementation</h3><p>The entire implementation code can be found at the <a href=https://github.com/prl-mushr/pose_prediction>car pose detection repo</a>.</p><p>After importing all the necessary modules and defining constants, the first thing the script will do is process the entire bag looking for the topics listed above. You will want:</p><ul><li>The pose of each car</li><li>The camera frames and camera info from one car</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>	<span class=kn>import</span> <span class=nn>rosbag</span>
</span></span><span class=line><span class=cl>	<span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl>	<span class=kn>import</span> <span class=nn>tf</span>
</span></span><span class=line><span class=cl>	<span class=kn>import</span> <span class=nn>rospy</span>
</span></span><span class=line><span class=cl>	<span class=kn>import</span> <span class=nn>cv2</span>
</span></span><span class=line><span class=cl>	<span class=kn>from</span> <span class=nn>cv_bridge</span> <span class=kn>import</span> <span class=n>CvBridge</span>
</span></span><span class=line><span class=cl>	<span class=kn>from</span> <span class=nn>image_geometry</span> <span class=kn>import</span> <span class=n>PinholeCameraModel</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>PATH_TO_INPUT_BAG</span> <span class=o>=</span> <span class=s1>&#39;/home/tudorf/mushr/catkin_ws/src/learning-image-geometry/car37_longtrim.bag&#39;</span>
</span></span><span class=line><span class=cl>	<span class=n>OUTPUT_VIDEO_NAME</span> <span class=o>=</span> <span class=s1>&#39;test&#39;</span>
</span></span><span class=line><span class=cl>	<span class=n>OUTPUT_VIDEO_FPS</span> <span class=o>=</span> <span class=mi>9</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>transformerROS</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>TransformerROS</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=n>bridge</span> <span class=o>=</span> <span class=n>CvBridge</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=n>camModel</span> <span class=o>=</span> <span class=n>PinholeCameraModel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=n>vid_out</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>VideoWriter</span><span class=p>(</span><span class=n>OUTPUT_VIDEO_NAME</span> <span class=o>+</span> <span class=s1>&#39;.avi&#39;</span><span class=p>,</span> <span class=n>cv2</span><span class=o>.</span><span class=n>VideoWriter_fourcc</span><span class=p>(</span><span class=o>*</span><span class=s1>&#39;MJPG&#39;</span><span class=p>),</span> <span class=n>OUTPUT_VIDEO_FPS</span><span class=p>,</span> <span class=p>(</span><span class=mi>640</span><span class=p>,</span><span class=mi>480</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>def</span> <span class=nf>translate_transform</span><span class=p>(</span><span class=n>p</span><span class=p>):</span>
</span></span><span class=line><span class=cl>		<span class=n>t</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>eye</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>t</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span><span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=n>p</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>		<span class=n>t</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=n>p</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>		<span class=n>t</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=n>p</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>t</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>def</span> <span class=nf>inverse_transform</span><span class=p>(</span><span class=n>t</span><span class=p>):</span>
</span></span><span class=line><span class=cl>		<span class=n>R_inv</span> <span class=o>=</span> <span class=n>t</span><span class=p>[:</span><span class=mi>3</span><span class=p>,:</span><span class=mi>3</span><span class=p>]</span><span class=o>.</span><span class=n>T</span>
</span></span><span class=line><span class=cl>		<span class=n>p_inv</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=o>-</span><span class=n>R_inv</span><span class=p>,</span><span class=n>t</span><span class=p>[:</span><span class=mi>3</span><span class=p>,</span><span class=mi>3</span><span class=p>])</span>
</span></span><span class=line><span class=cl>		<span class=n>t_inv</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>eye</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>t_inv</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>R_inv</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>		<span class=n>t_inv</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>R_inv</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>		<span class=n>t_inv</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=n>R_inv</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>		<span class=n>t_inv</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>R_inv</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>		<span class=n>t_inv</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>R_inv</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>		<span class=n>t_inv</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=n>R_inv</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>		<span class=n>t_inv</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>R_inv</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>		<span class=n>t_inv</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>R_inv</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>		<span class=n>t_inv</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=n>R_inv</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>		<span class=n>t_inv</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span><span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=n>p_inv</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>		<span class=n>t_inv</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=n>p_inv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>		<span class=n>t_inv</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=n>p_inv</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>t_inv</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>def</span> <span class=nf>get_corners</span><span class=p>(</span><span class=n>center_T_cam</span><span class=p>):</span>
</span></span><span class=line><span class=cl>		<span class=c1># center_T_cam is the transform of centerXX in terms of camYY, where we want the corners of carXX in terms of camYY</span>
</span></span><span class=line><span class=cl>		<span class=c1># dx,y,z are the dimensions of the car in the x,y,z directions from the center</span>
</span></span><span class=line><span class=cl>		<span class=n>dx</span> <span class=o>=</span> <span class=mf>0.22</span>
</span></span><span class=line><span class=cl>		<span class=n>dy</span> <span class=o>=</span> <span class=mf>0.134</span>
</span></span><span class=line><span class=cl>		<span class=n>dz</span> <span class=o>=</span> <span class=mf>0.079</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>			<span class=n>np</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>center_T_cam</span><span class=p>,</span> <span class=n>translate_transform</span><span class=p>([</span> <span class=n>dx</span><span class=p>,</span>  <span class=n>dy</span><span class=p>,</span>  <span class=n>dz</span><span class=p>])),</span>
</span></span><span class=line><span class=cl>			<span class=n>np</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>center_T_cam</span><span class=p>,</span> <span class=n>translate_transform</span><span class=p>([</span> <span class=n>dx</span><span class=p>,</span> <span class=o>-</span><span class=n>dy</span><span class=p>,</span>  <span class=n>dz</span><span class=p>])),</span>
</span></span><span class=line><span class=cl>			<span class=n>np</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>center_T_cam</span><span class=p>,</span> <span class=n>translate_transform</span><span class=p>([</span> <span class=n>dx</span><span class=p>,</span>  <span class=n>dy</span><span class=p>,</span> <span class=o>-</span><span class=n>dz</span><span class=p>])),</span>
</span></span><span class=line><span class=cl>			<span class=n>np</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>center_T_cam</span><span class=p>,</span> <span class=n>translate_transform</span><span class=p>([</span> <span class=n>dx</span><span class=p>,</span> <span class=o>-</span><span class=n>dy</span><span class=p>,</span> <span class=o>-</span><span class=n>dz</span><span class=p>])),</span>
</span></span><span class=line><span class=cl>			<span class=n>np</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>center_T_cam</span><span class=p>,</span> <span class=n>translate_transform</span><span class=p>([</span><span class=o>-</span><span class=n>dx</span><span class=p>,</span>  <span class=n>dy</span><span class=p>,</span>  <span class=n>dz</span><span class=p>])),</span>
</span></span><span class=line><span class=cl>			<span class=n>np</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>center_T_cam</span><span class=p>,</span> <span class=n>translate_transform</span><span class=p>([</span><span class=o>-</span><span class=n>dx</span><span class=p>,</span> <span class=o>-</span><span class=n>dy</span><span class=p>,</span>  <span class=n>dz</span><span class=p>])),</span>
</span></span><span class=line><span class=cl>			<span class=n>np</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>center_T_cam</span><span class=p>,</span> <span class=n>translate_transform</span><span class=p>([</span><span class=o>-</span><span class=n>dx</span><span class=p>,</span>  <span class=n>dy</span><span class=p>,</span> <span class=o>-</span><span class=n>dz</span><span class=p>])),</span>
</span></span><span class=line><span class=cl>			<span class=n>np</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>center_T_cam</span><span class=p>,</span> <span class=n>translate_transform</span><span class=p>([</span><span class=o>-</span><span class=n>dx</span><span class=p>,</span> <span class=o>-</span><span class=n>dy</span><span class=p>,</span> <span class=o>-</span><span class=n>dz</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>		<span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1># constant transforms</span>
</span></span><span class=line><span class=cl>	<span class=n>trackedPt_T_baselink</span> <span class=o>=</span> <span class=n>translate_transform</span><span class=p>([</span><span class=o>-</span><span class=mf>0.058325</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mf>0.08125</span><span class=p>])</span>
</span></span><span class=line><span class=cl>	<span class=n>colorCam_T_baselink</span> <span class=o>=</span> <span class=n>translate_transform</span><span class=p>([</span><span class=mf>0.02</span><span class=p>,</span> <span class=mf>0.033</span><span class=p>,</span> <span class=mf>0.068</span><span class=p>])</span>
</span></span><span class=line><span class=cl>	<span class=n>center_T_baselink</span> <span class=o>=</span> <span class=n>translate_transform</span><span class=p>([</span><span class=o>-</span><span class=mf>0.015</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>,</span> <span class=mf>0.003</span><span class=p>])</span>
</span></span><span class=line><span class=cl>	<span class=n>baselink_T_trackedPt</span> <span class=o>=</span> <span class=n>inverse_transform</span><span class=p>(</span><span class=n>trackedPt_T_baselink</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>bag</span> <span class=o>=</span> <span class=n>rosbag</span><span class=o>.</span><span class=n>Bag</span><span class=p>(</span><span class=n>PATH_TO_INPUT_BAG</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1># subscribe to all /vrpn_client_node/carXX/pose for cars in dataset</span>
</span></span><span class=line><span class=cl>	<span class=c1># subscribe to &#39;/carXX/camera/color/camera_info&#39; and &#39;/carXX/camera/color/image_throttled&#39; for camera car</span>
</span></span><span class=line><span class=cl>	<span class=n>topics</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;/vrpn_client_node/car35/pose&#39;</span><span class=p>,</span><span class=s1>&#39;/vrpn_client_node/car37/pose&#39;</span><span class=p>,</span><span class=s1>&#39;/vrpn_client_node/car38/pose&#39;</span><span class=p>,</span><span class=s1>&#39;/car37/camera/color/camera_info&#39;</span><span class=p>,</span><span class=s1>&#39;/car37/camera/color/image_throttled&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>ps_35</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>	<span class=n>ps_37</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>	<span class=n>ps_38</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>	<span class=n>camInfo</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>	<span class=n>cam_37</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=n>topic</span><span class=p>,</span> <span class=n>msg</span><span class=p>,</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>bag</span><span class=o>.</span><span class=n>read_messages</span><span class=p>(</span><span class=n>topics</span><span class=o>=</span><span class=n>topics</span><span class=p>):</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=n>topic</span> <span class=o>==</span> <span class=s1>&#39;/vrpn_client_node/car35/pose&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>ps_35</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>t</span><span class=p>,</span> <span class=n>msg</span><span class=o>.</span><span class=n>pose</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>elif</span> <span class=n>topic</span> <span class=o>==</span> <span class=s1>&#39;/vrpn_client_node/car37/pose&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>ps_37</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>t</span><span class=p>,</span> <span class=n>msg</span><span class=o>.</span><span class=n>pose</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>elif</span> <span class=n>topic</span> <span class=o>==</span> <span class=s1>&#39;/vrpn_client_node/car38/pose&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>ps_38</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>t</span><span class=p>,</span> <span class=n>msg</span><span class=o>.</span><span class=n>pose</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>elif</span> <span class=n>topic</span> <span class=o>==</span> <span class=s1>&#39;/car37/camera/color/camera_info&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>camInfo</span> <span class=o>=</span> <span class=n>msg</span>
</span></span><span class=line><span class=cl>		<span class=k>elif</span> <span class=n>topic</span> <span class=o>==</span> <span class=s1>&#39;/car37/camera/color/image_throttled&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>cam_37</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>t</span><span class=p>,</span> <span class=n>msg</span><span class=p>))</span></span></span></code></pre></td></tr></table></div></div><p>Next, it will step over each video frame. Since the motion capture data is published at a much higher rate, we must find the mocap data to each video frame. Each message of a rostopic has a timestamp, so we pick the mocap message with the closest timestamp to the video frame’s timestamp.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>	<span class=n>idx35</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	<span class=n>idx37</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	<span class=n>idx38</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=n>idxImg</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>cam_37</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>		<span class=n>targetT</span> <span class=o>=</span> <span class=n>cam_37</span><span class=p>[</span><span class=n>idxImg</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>		<span class=k>while</span> <span class=n>idx35</span><span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>ps_35</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span>   <span class=ow>and</span> <span class=n>ps_35</span><span class=p>[</span><span class=n>idx35</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span>   <span class=o>&lt;</span> <span class=n>targetT</span><span class=p>:</span> <span class=n>idx35</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>		<span class=k>while</span> <span class=n>idx37</span><span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>ps_37</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span>   <span class=ow>and</span> <span class=n>ps_37</span><span class=p>[</span><span class=n>idx37</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span>   <span class=o>&lt;</span> <span class=n>targetT</span><span class=p>:</span> <span class=n>idx37</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>		<span class=k>while</span> <span class=n>idx38</span><span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>ps_38</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span>   <span class=ow>and</span> <span class=n>ps_38</span><span class=p>[</span><span class=n>idx38</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span>   <span class=o>&lt;</span> <span class=n>targetT</span><span class=p>:</span> <span class=n>idx38</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1># pick closest mocap data, not next</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=n>idx35</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>targetT</span> <span class=o>-</span> <span class=n>ps_35</span><span class=p>[</span><span class=n>idx35</span><span class=o>-</span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>ps_35</span><span class=p>[</span><span class=n>idx35</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>-</span> <span class=n>targetT</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>idx35</span> <span class=o>-=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=n>idx37</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>targetT</span> <span class=o>-</span> <span class=n>ps_37</span><span class=p>[</span><span class=n>idx37</span><span class=o>-</span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>ps_37</span><span class=p>[</span><span class=n>idx37</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>-</span> <span class=n>targetT</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>idx37</span> <span class=o>-=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=n>idx38</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>targetT</span> <span class=o>-</span> <span class=n>ps_38</span><span class=p>[</span><span class=n>idx38</span><span class=o>-</span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>ps_38</span><span class=p>[</span><span class=n>idx38</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>-</span> <span class=n>targetT</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>idx38</span> <span class=o>-=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1># unwrap mocap pose into position, orientation</span>
</span></span><span class=line><span class=cl>		<span class=n>pos35</span> <span class=o>=</span> <span class=n>ps_35</span><span class=p>[</span><span class=n>idx35</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>position</span>
</span></span><span class=line><span class=cl>		<span class=n>ori35</span> <span class=o>=</span> <span class=n>ps_35</span><span class=p>[</span><span class=n>idx35</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>orientation</span>
</span></span><span class=line><span class=cl>		<span class=n>pos37</span> <span class=o>=</span> <span class=n>ps_37</span><span class=p>[</span><span class=n>idx37</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>position</span>
</span></span><span class=line><span class=cl>		<span class=n>ori37</span> <span class=o>=</span> <span class=n>ps_37</span><span class=p>[</span><span class=n>idx37</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>orientation</span>
</span></span><span class=line><span class=cl>		<span class=n>pos38</span> <span class=o>=</span> <span class=n>ps_38</span><span class=p>[</span><span class=n>idx38</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>position</span>
</span></span><span class=line><span class=cl>		<span class=n>ori38</span> <span class=o>=</span> <span class=n>ps_38</span><span class=p>[</span><span class=n>idx38</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>orientation</span>  
</span></span><span class=line><span class=cl>		</span></span></code></pre></td></tr></table></div></div><p>Next, we create and use transforms to identify where the other cars’ corners are on the frame. We load in the frame as an OpenCV image. Should you need to debug, you can draw the points of interest on the frame.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>    <span class=c1># create Transforms for TrackedPts w.r.t. World</span>
</span></span><span class=line><span class=cl>    <span class=n>pt35_T_w</span> <span class=o>=</span> <span class=n>transformerROS</span><span class=o>.</span><span class=n>fromTranslationRotation</span><span class=p>((</span><span class=n>pos35</span><span class=o>.</span><span class=n>x</span><span class=p>,</span> <span class=n>pos35</span><span class=o>.</span><span class=n>y</span><span class=p>,</span> <span class=n>pos35</span><span class=o>.</span><span class=n>z</span><span class=p>),</span> <span class=p>(</span><span class=n>ori35</span><span class=o>.</span><span class=n>x</span><span class=p>,</span> <span class=n>ori35</span><span class=o>.</span><span class=n>y</span><span class=p>,</span> <span class=n>ori35</span><span class=o>.</span><span class=n>z</span><span class=p>,</span> <span class=n>ori35</span><span class=o>.</span><span class=n>w</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>pt37_T_w</span> <span class=o>=</span> <span class=n>transformerROS</span><span class=o>.</span><span class=n>fromTranslationRotation</span><span class=p>((</span><span class=n>pos37</span><span class=o>.</span><span class=n>x</span><span class=p>,</span> <span class=n>pos37</span><span class=o>.</span><span class=n>y</span><span class=p>,</span> <span class=n>pos37</span><span class=o>.</span><span class=n>z</span><span class=p>),</span> <span class=p>(</span><span class=n>ori37</span><span class=o>.</span><span class=n>x</span><span class=p>,</span> <span class=n>ori37</span><span class=o>.</span><span class=n>y</span><span class=p>,</span> <span class=n>ori37</span><span class=o>.</span><span class=n>z</span><span class=p>,</span> <span class=n>ori37</span><span class=o>.</span><span class=n>w</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>pt38_T_w</span> <span class=o>=</span> <span class=n>transformerROS</span><span class=o>.</span><span class=n>fromTranslationRotation</span><span class=p>((</span><span class=n>pos38</span><span class=o>.</span><span class=n>x</span><span class=p>,</span> <span class=n>pos38</span><span class=o>.</span><span class=n>y</span><span class=p>,</span> <span class=n>pos38</span><span class=o>.</span><span class=n>z</span><span class=p>),</span> <span class=p>(</span><span class=n>ori38</span><span class=o>.</span><span class=n>x</span><span class=p>,</span> <span class=n>ori38</span><span class=o>.</span><span class=n>y</span><span class=p>,</span> <span class=n>ori38</span><span class=o>.</span><span class=n>z</span><span class=p>,</span> <span class=n>ori38</span><span class=o>.</span><span class=n>w</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># create Transforms for points of interest w.r.t. World</span>
</span></span><span class=line><span class=cl>    <span class=n>base37_T_w</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>pt37_T_w</span><span class=p>,</span> <span class=n>baselink_T_trackedPt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>cam37_T_w</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>base37_T_w</span><span class=p>,</span> <span class=n>colorCam_T_baselink</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>base35_T_w</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>pt35_T_w</span><span class=p>,</span> <span class=n>baselink_T_trackedPt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>center35_T_w</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>base35_T_w</span><span class=p>,</span> <span class=n>center_T_baselink</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>base38_T_w</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>pt38_T_w</span><span class=p>,</span> <span class=n>baselink_T_trackedPt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>center38_T_w</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>base38_T_w</span><span class=p>,</span> <span class=n>center_T_baselink</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># create Transforms for points of interest w.r.t. Camera</span>
</span></span><span class=line><span class=cl>    <span class=n>w_T_cam37</span> <span class=o>=</span> <span class=n>inverse_transform</span><span class=p>(</span><span class=n>cam37_T_w</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>center38_T_cam37</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>w_T_cam37</span><span class=p>,</span> <span class=n>center38_T_w</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>center35_T_cam37</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>w_T_cam37</span><span class=p>,</span> <span class=n>center35_T_w</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># create Transforms for bounding box corners</span>
</span></span><span class=line><span class=cl>    <span class=n>corners35</span> <span class=o>=</span> <span class=n>get_corners</span><span class=p>(</span><span class=n>center35_T_cam37</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>corners38</span> <span class=o>=</span> <span class=n>get_corners</span><span class=p>(</span><span class=n>center38_T_cam37</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p>Once we’ve found where each bounding box is, we have to decide whether or not to include it in the dataset. First we reject all labels of cars behind the camera. We also wish to throw out a label when one car is occluding another - we only want the front car to be labeled in this case.
Finally we save the image and its label in their corresponding locations.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>    <span class=c1># convert to OpenCV image</span>
</span></span><span class=line><span class=cl>    <span class=n>car37_image</span> <span class=o>=</span> <span class=n>bridge</span><span class=o>.</span><span class=n>imgmsg_to_cv2</span><span class=p>(</span><span class=n>cam_37</span><span class=p>[</span><span class=n>idxImg</span><span class=p>][</span><span class=mi>1</span><span class=p>],</span> <span class=s2>&#34;bgr8&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># find pixel coordinates of centroids</span>
</span></span><span class=line><span class=cl>    <span class=c1># the Camera Pinhole model uses +x right, +y down, +z forward</span>
</span></span><span class=line><span class=cl>    <span class=n>center35_3d</span> <span class=o>=</span> <span class=p>(</span><span class=o>-</span><span class=n>center35_T_cam37</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=mi>3</span><span class=p>],</span> <span class=o>-</span><span class=n>center35_T_cam37</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>],</span> <span class=n>center35_T_cam37</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span><span class=mi>3</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>center38_3d</span> <span class=o>=</span> <span class=p>(</span><span class=o>-</span><span class=n>center38_T_cam37</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=mi>3</span><span class=p>],</span> <span class=o>-</span><span class=n>center38_T_cam37</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>],</span> <span class=n>center38_T_cam37</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span><span class=mi>3</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>camModel</span><span class=o>.</span><span class=n>fromCameraInfo</span><span class=p>(</span><span class=n>camInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>center35_2d</span> <span class=o>=</span> <span class=n>camModel</span><span class=o>.</span><span class=n>project3dToPixel</span><span class=p>(</span><span class=n>center35_3d</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>center38_2d</span> <span class=o>=</span> <span class=n>camModel</span><span class=o>.</span><span class=n>project3dToPixel</span><span class=p>(</span><span class=n>center38_3d</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>center35_round</span> <span class=o>=</span> <span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>center35_2d</span><span class=p>[</span><span class=mi>0</span><span class=p>]),</span> <span class=nb>int</span><span class=p>(</span><span class=n>center35_2d</span><span class=p>[</span><span class=mi>1</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>    <span class=n>center38_round</span> <span class=o>=</span> <span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>center38_2d</span><span class=p>[</span><span class=mi>0</span><span class=p>]),</span> <span class=nb>int</span><span class=p>(</span><span class=n>center38_2d</span><span class=p>[</span><span class=mi>1</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># only draw on frame if the observed robot is behind the camera</span>
</span></span><span class=line><span class=cl>    <span class=n>car35_rect</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>center35_3d</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># draw centroid</span>
</span></span><span class=line><span class=cl>        <span class=n>cv2</span><span class=o>.</span><span class=n>circle</span><span class=p>(</span><span class=n>car37_image</span><span class=p>,</span> <span class=n>center35_round</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>255</span><span class=p>,</span><span class=mi>0</span><span class=p>),</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># initialize rectangle bounds to image size</span>
</span></span><span class=line><span class=cl>        <span class=c1># cv&#39;s image.shape is formatted as (height, width, length) a.k.a. (y, x, z)</span>
</span></span><span class=line><span class=cl>        <span class=n>xmin</span> <span class=o>=</span> <span class=n>car37_image</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>xmax</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>ymin</span> <span class=o>=</span> <span class=n>car37_image</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>ymax</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>corneridx</span><span class=p>,</span> <span class=n>corner</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>corners35</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=c1># find pixel coordinates of corners</span>
</span></span><span class=line><span class=cl>            <span class=n>corner_3d</span> <span class=o>=</span> <span class=p>(</span><span class=o>-</span><span class=n>corner</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=mi>3</span><span class=p>],</span> <span class=o>-</span><span class=n>corner</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>],</span> <span class=n>corner</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span><span class=mi>3</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>corner_2d</span> <span class=o>=</span> <span class=n>camModel</span><span class=o>.</span><span class=n>project3dToPixel</span><span class=p>(</span><span class=n>corner_3d</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>corner_round</span> <span class=o>=</span> <span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>corner_2d</span><span class=p>[</span><span class=mi>0</span><span class=p>]),</span> <span class=nb>int</span><span class=p>(</span><span class=n>corner_2d</span><span class=p>[</span><span class=mi>1</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>            <span class=c1># draw the front (first 4) corners in different colors</span>
</span></span><span class=line><span class=cl>            <span class=n>color</span> <span class=o>=</span> <span class=p>(</span><span class=mi>255</span><span class=p>,</span><span class=mi>255</span><span class=p>,</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>cv2</span><span class=o>.</span><span class=n>circle</span><span class=p>(</span><span class=n>car37_image</span><span class=p>,</span> <span class=n>corner_round</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=n>color</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>xmin</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=n>xmin</span><span class=p>,</span> <span class=n>corner_round</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>xmax</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>xmax</span><span class=p>,</span> <span class=n>corner_round</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>ymin</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=n>ymin</span><span class=p>,</span> <span class=n>corner_round</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>ymax</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>ymax</span><span class=p>,</span> <span class=n>corner_round</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># save rectangle</span>
</span></span><span class=line><span class=cl>        <span class=n>car35_rect</span> <span class=o>=</span> <span class=p>((</span><span class=n>xmin</span><span class=p>,</span> <span class=n>ymin</span><span class=p>),</span> <span class=p>(</span><span class=n>xmax</span><span class=p>,</span> <span class=n>ymax</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>car38_rect</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>center38_3d</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># draw centroid</span>
</span></span><span class=line><span class=cl>        <span class=n>cv2</span><span class=o>.</span><span class=n>circle</span><span class=p>(</span><span class=n>car37_image</span><span class=p>,</span> <span class=n>center38_round</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>255</span><span class=p>,</span><span class=mi>0</span><span class=p>),</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># cv&#39;s image.shape is formatted as (height, width, length) a.k.a. (y, x, z)</span>
</span></span><span class=line><span class=cl>        <span class=n>xmin</span> <span class=o>=</span> <span class=n>car37_image</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>xmax</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>ymin</span> <span class=o>=</span> <span class=n>car37_image</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>ymax</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>corneridx</span><span class=p>,</span> <span class=n>corner</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>corners38</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=c1># find pixel coordinates of corners</span>
</span></span><span class=line><span class=cl>            <span class=n>corner_3d</span> <span class=o>=</span> <span class=p>(</span><span class=o>-</span><span class=n>corner</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=mi>3</span><span class=p>],</span> <span class=o>-</span><span class=n>corner</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>],</span> <span class=n>corner</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span><span class=mi>3</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>corner_2d</span> <span class=o>=</span> <span class=n>camModel</span><span class=o>.</span><span class=n>project3dToPixel</span><span class=p>(</span><span class=n>corner_3d</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>corner_round</span> <span class=o>=</span> <span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>corner_2d</span><span class=p>[</span><span class=mi>0</span><span class=p>]),</span> <span class=nb>int</span><span class=p>(</span><span class=n>corner_2d</span><span class=p>[</span><span class=mi>1</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>            <span class=c1># draw the front (first 4) corners in different colors</span>
</span></span><span class=line><span class=cl>            <span class=n>color</span> <span class=o>=</span> <span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>255</span><span class=p>,</span><span class=mi>255</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>cv2</span><span class=o>.</span><span class=n>circle</span><span class=p>(</span><span class=n>car37_image</span><span class=p>,</span> <span class=n>corner_round</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=n>color</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>xmin</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=n>xmin</span><span class=p>,</span> <span class=n>corner_round</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>xmax</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>xmax</span><span class=p>,</span> <span class=n>corner_round</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>ymin</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=n>ymin</span><span class=p>,</span> <span class=n>corner_round</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>ymax</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>ymax</span><span class=p>,</span> <span class=n>corner_round</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># save rectangle</span>
</span></span><span class=line><span class=cl>        <span class=n>car38_rect</span> <span class=o>=</span> <span class=p>((</span><span class=n>xmin</span><span class=p>,</span> <span class=n>ymin</span><span class=p>),</span> <span class=p>(</span><span class=n>xmax</span><span class=p>,</span> <span class=n>ymax</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># draw rectangles &amp; check for overlap</span>
</span></span><span class=line><span class=cl>    <span class=n>overlap_tolerance</span> <span class=o>=</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>car35_rect</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>car38_rect</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>car35_rect</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>car38_rect</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>-</span> <span class=n>overlap_tolerance</span> <span class=ow>and</span> <span class=n>car35_rect</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>car38_rect</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>overlap_tolerance</span> <span class=ow>and</span> \
</span></span><span class=line><span class=cl>                <span class=n>car35_rect</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>car38_rect</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=n>overlap_tolerance</span> <span class=ow>and</span> <span class=n>car35_rect</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>car38_rect</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>+</span> <span class=n>overlap_tolerance</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=c1># reject draw</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;car38 overlaps car35&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>cv2</span><span class=o>.</span><span class=n>rectangle</span><span class=p>(</span><span class=n>car37_image</span><span class=p>,</span> <span class=n>car35_rect</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>car35_rect</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>255</span><span class=p>,</span><span class=mi>0</span><span class=p>),</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>cv2</span><span class=o>.</span><span class=n>rectangle</span><span class=p>(</span><span class=n>car37_image</span><span class=p>,</span> <span class=n>car35_rect</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>car35_rect</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>255</span><span class=p>,</span><span class=mi>0</span><span class=p>),</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>car38_rect</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>car35_rect</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>car38_rect</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>car35_rect</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>-</span> <span class=n>overlap_tolerance</span> <span class=ow>and</span> <span class=n>car38_rect</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>car35_rect</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>overlap_tolerance</span> <span class=ow>and</span> \
</span></span><span class=line><span class=cl>                <span class=n>car38_rect</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>car35_rect</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=n>overlap_tolerance</span> <span class=ow>and</span> <span class=n>car38_rect</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>car35_rect</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>+</span> <span class=n>overlap_tolerance</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=c1># reject draw</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;car35 overlaps car38&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>cv2</span><span class=o>.</span><span class=n>rectangle</span><span class=p>(</span><span class=n>car37_image</span><span class=p>,</span> <span class=n>car38_rect</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>car38_rect</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>255</span><span class=p>),</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>cv2</span><span class=o>.</span><span class=n>rectangle</span><span class=p>(</span><span class=n>car37_image</span><span class=p>,</span> <span class=n>car38_rect</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>car38_rect</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>255</span><span class=p>),</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Add frame to video</span>
</span></span><span class=line><span class=cl>    <span class=n>vid_out</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>car37_image</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=s1>&#39;uint8&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1># end video</span>
</span></span><span class=line><span class=cl>	<span class=n>vid_out</span><span class=o>.</span><span class=n>release</span><span class=p>()</span></span></span></code></pre></td></tr></table></div></div><h2 id=setting-up-yolov5>Setting Up YOLOv5</h2><p>First clone the YOLOv5 repo:
- <a href=https://github.com/ultralytics/yolov5>https://github.com/ultralytics/yolov5</a></p><p>Now install all the requirements from requirements.txt
Now create your train/valid/test files. Each file will contain the location of the images you will use for training (the labels will be automatically grabbed since the directory structure is known ahead of time). We split our dataset in a 70/20/10 ratio for train/valid/test, respectively.</p><p>Here are the first 3 lines of our train.txt:</p><ul><li>/mnt/hard_data/carpose/dataset/images/car37_longtrim_000000.jpg</li><li>/mnt/hard_data/carpose/dataset/images/car37_longtrim_000001.jpg</li><li>/mnt/hard_data/carpose/dataset/images/car37_longtrim_000002.jpg</li></ul><p>Next create carpose.yaml, which will describe the dataset. Fill in the paths to your train/valid/test files. We only have 1 class: Car.</p><p>Here is our carpose.yaml file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># train and val datasets (image directory or *.txt file with image paths)</span>
</span></span><span class=line><span class=cl>train: /home/ugrads/WRK/carpose/src/yolov5/data/train.txt
</span></span><span class=line><span class=cl>val: /home/ugrads/WRK/carpose/src/yolov5/data/valid.txt
</span></span><span class=line><span class=cl>test: /home/ugrads/WRK/carpose/src/yolov5/data/test.txt
</span></span><span class=line><span class=cl><span class=c1># number of classes in your dataset</span>
</span></span><span class=line><span class=cl>nc: <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=c1># class names</span>
</span></span><span class=line><span class=cl>names: <span class=o>[</span><span class=s1>&#39;Car&#39;</span><span class=o>]</span></span></span></code></pre></div><p>This file should be in yolov5/data.</p><h2 id=training-your-model>Training Your Model</h2><p>Now we can begin training our model! YOLOv5 has four different model sizes: S, M, L, and XL. We used the smallest: yolov5s.yaml.
The parameters we used were:
python train.py &ndash;data ./data/carpose.yaml &ndash;cfg ./models/yolov5s.yaml &ndash;logdir /mnt/hard_data/Checkpoints/carpose/runs/ &ndash;workers 0 &ndash;img-size 640 &ndash;single-cls &ndash;device 1 &ndash;batch 16 &ndash;epochs 10 &ndash;weights &lsquo;’</p><p>Change the logdir to wherever you want the output to be, this will include model checkpoints, plots, and examples from each epoch. The &ndash;workers parameter only worked when set to 0 for us. The &ndash;device parameter selects which cuda device to use. You can increase/decrease the batch size based on your GPU, and change the training length (epochs). You can also use previously stored weights by filling in the &ndash;weights parameter.</p><p>Alternatively, you can download <a href="https://drive.google.com/file/d/1P3yP3Jq1Om5sCu4UxNh2ctcXkRiMI0s0/view?usp=sharing">our trained model</a>.</p><h2 id=demo-video>Demo Video</h2><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://www.youtube.com/embed/Vrt8OyOOJA8 style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="YouTube Video"></iframe></div><hr></div></div></div></div></div><div class="strip strip-primary-gradient-top-bottom"><div class="container pt-3 pb-3 pt-md-6 pb-md-3 px-2"><div class="row justify-content-left citation-row"><h1 id=citation>Citation</h1><p>If you plan to use any part of the the MuSHR platform (including tutorials, codebase, or hardware instructions) for a project or paper, please cite
<em><a href=https://arxiv.org/abs/1908.08031>MuSHR: A Low-Cost, Open-Source Robotic Racecar for Education and Research</a></em>.</p><div class=highlight><pre class=chroma>@article{srinivasa2019mushr,
 title={{MuSHR}: A Low-Cost, Open-Source Robotic Racecar for Education and Research},
 author={Srinivasa, Siddhartha S. and Lancaster, Patrick and Michalove, Johan and Schmittle, Matt and Summers, Colin and Rockett, Matthew and Smith, Joshua R. and Chouhury, Sanjiban and Mavrogiannis, Christoforos and Sadeghi, Fereshteh},
 journal={CoRR},
 volume={abs/1908.08031},
 year={2019}
}
</pre></div><br></div></div></div></div><div class=footer><div class=container><div class=row><div class=col-12><div class=footer-inner><h3 class=footer-title>MuSHR: The UW Open Racecar Project</h3><ul><li class=menu-item-forum><a href=https://github.com/prl-mushr/mushr/discussions>Community Forum</a></li><li class=menu-item-contact><a href=/contact/>Contact</a></li><li class=menu-item-home><a href=/>Home</a></li></ul></div></div></div></div></div><div class=sub-footer><div class=container><div class=row><div class=col-12><div class=sub-footer-inner><ul></ul><ul><li class=prl>Made with <font color=#FF1690>♥</font> at the <a href=https://personalrobotics.cs.washington.edu/>Personal Robotics Lab</a></li></ul><ul><li class=prl>Website by <a href=https://micha.love/><font color=#36CDC4>Johan</font></a></li></ul></div></div></div></div></div><script type=text/javascript src=/js/scripts.min.8504133605a277da18f0d58cfd2e90d154962f4a961543a6e2f0a459a2d05462.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-146151202-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-146151202-1")</script></body></html>