<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><title>Tuning Guide - MuSHR: The UW Open Racecar Project</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=https://mushr.io/favicon.png><link rel=stylesheet href=/css/style.min.d6c2c7df4a2b74e47c295ee499fec19eb99dfe63f90766a829090f557e381bdc.css></head><body class='page page-tutorials-single'><div id=main-menu-mobile class=main-menu-mobile><ul><li class=menu-item-quickstart><a href=/tutorials/noetic_quickstart/><span>Quickstart</span></a></li><li class=menu-item-about><a href=/about/><span>About</span></a></li><li class=menu-item-docs><a href=https://github.com/prl-mushr/mushr#component-documentation><span>Docs</span></a></li><li class=menu-item-hardware><a href=/hardware/><span>Hardware</span></a></li><li class="menu-item-tutorials active"><a href=/tutorials/><span>Tutorials</span></a></li><li class=menu-item-press><a href=/press/><span>Press</span></a></li><li class=menu-item-team><a href=https://personalrobotics.cs.washington.edu/people/><span>Team</span></a></li><li class=menu-item-forum><a href=https://github.com/prl-mushr/mushr/discussions><span>Community Forum</span></a></li><li class=menu-item-contact><a href=/contact/><span>Contact</span></a></li></ul></div><div class=wrapper><div class=header><div class=container><div class=logo><a href=https://mushr.io/><img alt="Figurit Homepage" src=https://mushr.io/imgs/mushr-logo.svg></a></div><div class=logo-mobile><a href=https://mushr.io/><img alt="Figurit Homepage" src=https://mushr.io/imgs/mushr-logo.svg></a></div><div id=main-menu class=main-menu><ul><li class=menu-item-quickstart><a href=/tutorials/noetic_quickstart/><span>Quickstart</span></a></li><li class=menu-item-about><a href=/about/><span>About</span></a></li><li class=menu-item-docs><a href=https://github.com/prl-mushr/mushr#component-documentation><span>Docs</span></a></li><li class=menu-item-hardware><a href=/hardware/><span>Hardware</span></a></li><li class="menu-item-tutorials active"><a href=/tutorials/><span>Tutorials</span></a></li><li class=menu-item-press><a href=/press/><span>Press</span></a></li><li class=menu-item-team><a href=https://personalrobotics.cs.washington.edu/people/><span>Team</span></a></li><li class=menu-item-forum><a href=https://github.com/prl-mushr/mushr/discussions><span>Community Forum</span></a></li><li class=menu-item-contact><a href=/contact/><span>Contact</span></a></li></ul></div><button id=toggle-main-menu-mobile class="hamburger hamburger--slider" role=presentation aria-label="mobile menu trigger">
<span class=hamburger-box><span class=hamburger-inner></span></span></button></div></div><div class="container pb-6 pt-6 pt-md-10 pb-md-10"><div class="row justify-content-start"><div class="col-12 col-md-8"><div class="tutorial tutorial-single"><h1 class=title>Tuning Guide</h1><div class=content><p>Fine tuning car specific control parameters.</p><h4 class=properties>Beginner Tutorial | Expected duration is 60 minutes</h4><h2>By: <a href=https://github.com/Rockett8855>Matthew Rockett</a></h2><figure><video width=32% muted autoplay loop>
<source src=/tutorials/tuning/steering_angle_offset/left.mp4 type=video/mp4></video>
<video width=32% muted autoplay loop>
<source src=/tutorials/tuning/steering_angle_offset/straight.mp4 type=video/mp4></video>
<video width=32% muted autoplay loop>
<source src=/tutorials/tuning/steering_angle_offset/right.mp4 type=video/mp4></video></figure><h3 id=introduction>Introduction</h3><p>The VESC maps input velocities (m/s) and steering angles (radians) to Electrical RPMs and servo positions. Due to small physical differences in the car, the parameters of the conversion need to be tuned to the specific car. This guide will provide you with the steps needed to tune the parameters of the VESC.</p><p>If incorrectly tuned, the commands applied by your autonomous controller may not correspond to what&rsquo;s being executed on the physical hardware, making it difficult to debug issues with the controller. You as a controller turn out to be pretty good at self correcting, but your autonomous controllers may not fair as well.</p><p><strong>Note:</strong> The conversion from velocity to ERPM and steering angle to servo position is a linear function of the input command:</p><div style=text-align:center><code>output = f(command) = gain * command + bias</code>,<br><br></div><p>so the values may not be acurate for large ranges of speeds. Try to tune around the speed you expect to drive at (and consider retuning if your speed regime changes drasically).</p><h3 id=goal>Goal</h3><p>Set the VESC gains (multiplier/strength of an input) and offsets (defualt value when no control is applied).</p><h3 id=requirements>Requirements</h3><ul><li>A computer that can <code>ssh</code> into your car.</li><li>A tape measure.</li></ul><h2 id=setup>Setup</h2><p>Find a relatively open space to run your car. We&rsquo;ll be driving it straight for ~9ft (3m) and turning in a semi-circle of diameter ~6ft (2m).</p><p>Plug the batteries into the car, connect to the car&rsquo;s network and <code>ssh</code> into the car.</p><p>The file will be located at:</p><div style=text-align:center><code>~/catkin_ws/src/mushr_base/vesc/vesc_main/config/racecar-uw-nano/vesc.yaml</code>.<br><br></div><p>If you have a different version of the car, you&rsquo;ll choose that one instead. If you don&rsquo;t know which car you have, you likely have the <code>racecar-uw-nano</code> version.</p><p>The file will look like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># erpm (electrical rpm) = speed_to_erpm_gain * speed (meters / second) + speed_to_erpm_offset</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#-4614</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>speed_to_erpm_gain</span><span class=p>:</span><span class=w> </span>-<span class=m>2000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>speed_to_erpm_offset</span><span class=p>:</span><span class=w> </span><span class=m>0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=l>...omited for brevity]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># servo value (0 to 1) =  steering_angle_to_servo_gain * steering angle (radians) + steering_angle_to_servo_offset</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>steering_angle_to_servo_gain</span><span class=p>:</span><span class=w> </span><span class=m>1.2135</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>steering_angle_to_servo_offset</span><span class=p>:</span><span class=w> </span><span class=m>0.55</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=l>...omited for brevity]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>vesc_driver</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=l>/dev/vesc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>[</span><span class=l>...omited for brevity]</span><span class=w>
</span></span></span></code></pre></div><h2 id=steering-angle-offset>Steering Angle Offset</h2><p>This offset sets the default servo position when the car is driving straight.</p><h3 id=how-to-tune>How to Tune</h3><p>You will be changing the variable: <code>steering_angle_to_servo_offset</code>.</p><h4 id=tuning-loop>Tuning loop:</h4><p>While the car doesn&rsquo;t drive straight, do the following procedure:</p><ol><li>Start teleop:</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>roslaunch mushr_base teleop.launch
</span></span></code></pre></div><ul><li>Drive car in a straight line a few times. It&rsquo;s never going to be perfectly straight, so as long as it goes straight most of the time, it&rsquo;ll be fine. You can always come back to retune if it&rsquo;s not sufficiently precise.</li><li>Adjust <code>steering_angle_offset</code> in <code>vesc.yaml</code>. Increase the offset if the car veers too much left, decrease if it veers too much right.</li><li>Stop teleop (<code>Ctrl-C</code> in the window you started <code>teleop.launch</code> in) and go back to Step 1.</li></ul><p><strong>Note: Usually this value is between 0.4 and 0.6</strong></p><figure><video width=32% muted autoplay loop>
<source src=/tutorials/tuning/steering_angle_offset/left.mp4 type=video/mp4></video>
<video width=32% muted autoplay loop>
<source src=/tutorials/tuning/steering_angle_offset/straight.mp4 type=video/mp4></video>
<video width=32% muted autoplay loop>
<source src=/tutorials/tuning/steering_angle_offset/right.mp4 type=video/mp4></video><figcaption><p>The car during the tuning process. In all tests, the car is commanded to drive straight forward. In the left image, the car's steering angle offset is too high. In the center image, the offset is good. In the right image the offset is too low. <b>Note: the car will never drive perfectly straight. It just has to be good enough. In the future your controller will be able to make small corrections!</b></p></figcaption></figure><h2 id=speed-to-erpm-gain>Speed to ERPM Gain</h2><p>This gain converts velocity to ERPM.</p><h3 id=how-to-tune-1>How to Tune</h3><p>You will be changing the variable: <code>speed_to_erpm_gain</code>.</p><h4 id=before-tuning>Before tuning:</h4><ol><li>Extend your tape measure to around 9-10 ft on the floor. It&rsquo;s okay if it&rsquo;s slightly less than this.<figure><img src=/tutorials/tuning/erpm_gain/start.jpg width=300px></figure></li></ol><h4 id=tuning-loop-1>Tuning loop:</h4><p>Now, while the car does not drive the reported distance (by <code>rostopic echo</code> command):</p><ol><li>Place car at the base of the tape measure with the back wheelbase (indicated with a white line) lined up with 0.<figure><img src=/tutorials/tuning/erpm_gain/base_with_line.jpg width=300px></figure></li></ol><ul><li>Start teleop.</li><li>Open another terminal on the car and run the command:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>rostopic echo /car/vesc/odom/pose/pose/position/x
</span></span></code></pre></div><p>This will echo all the odometry information &ndash; how far the car has driven (in meters) in the <code>x</code> direction since teleop started. The value should be <code>0.0</code> at the start, as the car hasn&rsquo;t moved yet.</p><ul><li>Drive the car forward about 7-8 ft. The car will drive slightly further as it decelerates and stops. Make sure you only drive forward, not altering the servo position, otherwise you&rsquo;ll have both <code>x</code> and <code>y</code> directional changes (which makes it only slightly harder to check distance traveled).</li><li>Record the distance traveled. If your tape measure is in inches, convert to meters.<figure><img src=/tutorials/tuning/erpm_gain/end_with_line.jpg width=400px></figure></li><li>Compare to output of the <code>rostopic echo</code> command&rsquo;s <code>x</code> value. If the reported distance traveled is larger than the actual, decrease the gain. If the reported distance is smaller, increase the gain. At the begining increasing or decreasing by 500 should allow you to quickly hone in on the value.</li><li>Stop teleop. Go back to step 1 if the values are not sufficiently close (within 2-3 cm).</li></ul><p><strong>Note: This value can vary, but it should be on the order of thousands (2000-5000)</strong></p><p>A good stopping criteria is when the reported distance is within 2-3 inches (0.05-0.076m) of the actual distance. Sometimes the servo will get stuck and veer off course. You can restart teleop and move the car back and try again if this happens. Remember we are looking to get &ldquo;good&rdquo; gains, not perfect gains.</p><h2 id=steering-angle-gain>Steering Angle Gain</h2><p>This gain takes a steering angle in radians and converts it to a servo position. In order to find the desired turn radius, we look to the <a href=https://github.com/prl-mushr/mushr/blob/master/mushr_description/kinematic_car_model.pdf>kinematic car model</a>. At low enough speeds (avoiding slipping and skidding) this model farily accurately represents the movement of the car. The turn radius is:</p><center>`R = L/2sin(beta)`,</center><p>where <code>L</code> is the length of the car (0.3 meters), and beta is <code>arctan(1/2 * tan(delta))</code>, where delta is the steering angle. We will be setting the steering angle to the max (0.34 by default).</p><p>We will instead the length of a half cirlce, so <code>2 * R</code>. Calculting this with the defaults, comes out to 1.722 meters (67.79 inches). If you tweak the max steering angle, or change the chassis, you will have to recompute this number.</p><h3 id=how-to-tune-2>How to Tune</h3><p>You will be changing the variable: <code>steering_angle_to_servo_gain</code>.</p><h4 id=before-tuning-1>Before tuning:</h4><ol><li>Extend your tape measure to around 7-8 ft on the floor, similar to the tuning procedure above.</li></ol><h4 id=tuning-loop-2>Tuning loop:</h4><p>While the car doesn&rsquo;t drive :</p><ol><li>Place car at the base of the tape measure with the back wheelbase (indicated with a white line) lined up with 0.<figure><img src=/tutorials/tuning/steering_angle_gain/start.jpg width=300px></figure></li></ol><ul><li>Start teleop.</li><li>Command the steering wheel max in whichever direction the measurement tape is. (For the image, it would be left)</li><li>Run the car such that the car has run over the tape and the back wheel is on the tape (see image). This will take some practice, but you can go slow.<figure><img src=/tutorials/tuning/steering_angle_gain/end.jpg width=300px></figure></li><li>Record the distance. The goal distance is <strong>1.722 meters (67.79 inches)</strong>. If it overshot, increase the gain, if it undershot, decrease the gain.</li></ul><p><strong>Note: This value should be around 1.1-1.3</strong></p><h2 id=conclusion>Conclusion</h2><p>With these values, your car should follow input commands much more faithfully.</p></div></div></div></div></div><div class="strip strip-primary-gradient-top-bottom"><div class="container pt-3 pb-3 pt-md-6 pb-md-3 px-2"><div class="row justify-content-left citation-row"><h1 id=citation>Citation</h1><p>If you plan to use any part of the the MuSHR platform (including tutorials, codebase, or hardware instructions) for a project or paper, please cite
<em><a href=https://arxiv.org/abs/1908.08031>MuSHR: A Low-Cost, Open-Source Robotic Racecar for Education and Research</a></em>.</p><div class=highlight><pre class=chroma>@article{srinivasa2019mushr,
 title={{MuSHR}: A Low-Cost, Open-Source Robotic Racecar for Education and Research},
 author={Srinivasa, Siddhartha S. and Lancaster, Patrick and Michalove, Johan and Schmittle, Matt and Summers, Colin and Rockett, Matthew and Smith, Joshua R. and Chouhury, Sanjiban and Mavrogiannis, Christoforos and Sadeghi, Fereshteh},
 journal={CoRR},
 volume={abs/1908.08031},
 year={2019}
}
</pre></div><br></div></div></div></div><div class=footer><div class=container><div class=row><div class=col-12><div class=footer-inner><h3 class=footer-title>MuSHR: The UW Open Racecar Project</h3><ul><li class=menu-item-forum><a href=https://github.com/prl-mushr/mushr/discussions>Community Forum</a></li><li class=menu-item-contact><a href=/contact/>Contact</a></li><li class=menu-item-home><a href=/>Home</a></li></ul></div></div></div></div></div><div class=sub-footer><div class=container><div class=row><div class=col-12><div class=sub-footer-inner><ul></ul><ul><li class=prl>Made with <font color=#FF1690>â™¥</font> at the <a href=https://personalrobotics.cs.washington.edu/>Personal Robotics Lab</a></li></ul><ul><li class=prl>Website by <a href=https://micha.love/><font color=#36CDC4>Johan</font></a></li></ul></div></div></div></div></div><script type=text/javascript src=/js/scripts.min.8504133605a277da18f0d58cfd2e90d154962f4a961543a6e2f0a459a2d05462.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-146151202-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-146151202-1")</script></body></html>